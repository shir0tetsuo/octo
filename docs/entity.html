<!DOCTYPE html>
<html lang="en">
    <head>
        
        <title>Entity</title>
        <!-- https://remixicon.com/ -->
        <link
            href="https://cdn.jsdelivr.net/npm/remixicon@4.7.0/fonts/remixicon.css"
            rel="stylesheet"
        />
        <!-- favicon block -->
        <link rel="icon" type="image/png" sizes="512x512" href="favicon/android-chrome-512x512.png">
        <link rel="icon" type="image/png" sizes="192x192" href="favicon/android-chrome-192x192.png">
        <link rel="icon" type="image/png" sizes="32x32" href="favicon/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="favicon/favicon-16x16.png">
        <link rel="apple-touch-icon" href="favicon/apple-touch-icon.png">
        <link rel="alternate icon" href="favicon/favicon.ico">
        <!-- jquery block -->
        <script src="js/jquery-3.7.1.js"></script>

        <link rel="stylesheet" href="css/common.css">
        <link rel="stylesheet" href="css/map.css">
        <link rel="stylesheet" href="css/map_elements.css">
        <link rel="stylesheet" href="css/entity.css">

        <!-- Bots No Index No Follow -->
        <meta name="ROBOTS" content="NOINDEX,NOFOLLOW">

        <!-- For mobile support -->
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <meta name="theme-color" content="#3da79a">
        <meta property="og:site_name" content="Octo Application">
        <meta property="og:image" content="./img/about-bg.gif">
        <meta data-react-helmet="true" property="og:description" content="Lightweight repository project interacts with API Servers for a simple Data Library">    

    </head>
    <body>
        <div class="topnavigator">
            <div class="topleftbox">
                <div class="floating-right" id="loading"><div class="bouncing-loader"><div></div><div></div><div></div></div></div>
                
                <!-- Common -->
                <div class="topnavleft"><a href="index.html"><i class="ri-base-station-fill"></i> status</a></div>
                <div class="topnavleft"><a href="login.html?redirect=map.html" class="phasedBlue" id="user-login-nav"><i class="ri-passport-line"></i> login</a></div>
                <!-- Map View Navigation -->
                <div class="topnavleft"><a href="#" class="phasedYel" id="area-nav"><i class="ri-treasure-map-line"></i> area</a></div>
                <div class="topnavleft"><a href="#" class="phasedYel" onclick="safeExit()"><i class="ri-corner-down-left-fill"></i> Return</a></div>
                <div class="topnavleft"><a href="#" class="phasedYel" id="x_minus"><i class="ri-arrow-left-circle-line"></i> Back</a></div>
                <div class="topnavleft"><a href="#" class="phasedYel" id="x_plus"><i class="ri-arrow-right-circle-line"></i> Continue</a></div>

                <div class="skeleton-image" id="skeletonloading"></div>
            </div>
        </div>


        <div class="container" id="container">


            <div class="cardWrapper">

                <!-- TOP TOOLS -->
                <div class="tools holoshim">
                    <a><span><i class="ri-file-shred-fill"></i> rm</span></a>
                    |
                    <a><span><i class="ri-pencil-ai-fill"></i> edit</span></a>
                    |
                    <a><span><i class="ri-user-fill"></i> 00000000</span></a>
                    <div class="iter-number">#0</div>
                </div>

                
                    
                <!-- SHADER LAYER -->
                <div class="card specular">
                    <div class="cell-bar" style="position: absolute; top: 250px;"></div>
                    <div class="cell-bar" style="position: absolute; top: 450px;"></div>
                    <!-- INNER CARD CONTENTS ///////////////////////////// -->
                    <div class="content wordbreak" style="word-break: break-all;">
                        <div class="description">
                            I am the wind through the leaves,
                            I am the wave on the sea,
                            I am the murmur of the willows,
                            I am the crow upon the rocks,
                            I am a beam of sun,
                            I am the fairest of plants,
                            I am the wild stag of the forest,
                            I am the grass in the fields,
                            I am the word of knowledge.
                            Who is it who listens to the trees?
                            Who announces the ages of the moon?
                            Who remembers the old ways,
                            If not I?
                        </div>
                        <!-- CARD UUID AT BOTTOM OF CARD (CUTS OFF TEXT)-->
                        <div class="cardID">
                            <span><i class="ri-focus-2-line"></i>de0d16af-a0fa-4c6c-9616-0d4b431d1835</span> 
                        </div>
                    </div>
                    <!-- (END) INNER CARD CONTENTS /////////////////////// -->

                    <!-- Central Elements -->
                    <div class="cardCenter">
                        Genesis
                        <br>
                        <div class="ts">
                            --:--:--:--
                        </div>
                    </div>

                    <div>
                        <!-- Glyph Elements -->
                        <div class="glyph-top topElements">
                            <div class="glyph-slot glyph-actual">ð“…“</div>
                            <div class="glyph-slot glyph-actual">ð“…“</div>
                            <div class="glyph-slot glyph-actual">ð“…“</div>
                            <div class="glyph-slot glyph-actual">ð“…“</div>
                            <!-- Mint Area-->
                            <div class="glyph-slot holoshim" style="font-size: 30px;">
                                <i class="ri-copper-coin-fill"></i>
                            </div>
                        </div>

                        <div class="glyph-bottom bottomElements">
                            <div class="glyph-slot glyph-actual">ð“…“</div>
                            <div class="glyph-slot glyph-actual">ð“…“</div>
                            <div class="glyph-slot glyph-actual">ð“…“</div>
                            <div class="glyph-slot glyph-actual">ð“…“</div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <script type="text/javascript">

            const container = document.getElementById('container');
            var selected = 0;

            function safeRedirect(path) {
                if (path && path.startsWith("/") && !path.startsWith("//")) {
                    window.location.href = path;
                } else {
                    window.location.href = "./index.html";
                }
            };

            function safeExit() {
                const params = new URLSearchParams(window.location.search);
                const redirectTo = params.get("redirect") || "./index.html";
                safeRedirect(redirectTo);
            };

            function RenderFactory(url, x, y, z, i, apikey=null) {
                return $.ajax({
                    type: "POST",
                    url: url,
                    timeout: 1500,
                    contentType: "application/json",
                    dataType: "json",
                    headers: apikey ? { "X-API-Key": apikey } : {},
                    data: JSON.stringify({ 'x_pos': x, 'y_pos': y, 'zone': z, 'iter': i })
                })
            }

            function illuminate(list_of_colors) {
                list_of_colors.forEach((value, i) => {
                    document.documentElement.style.setProperty(`--banner-channel-${i}`, value);
                });
            }

            function ChangeUserNav(res) {
                nav = document.getElementById('user-login-nav');
                if (res.user_context.decryption_success) {
                    redirect = encodeURIComponent(window.location.pathname + window.location.search);
                    nav.href = 'user.html?redirect=' + redirect; // This will point to the user page
                    nav.innerHTML = '<i class="ri-passport-fill"></i> ' + String(res.user_context.ID).split('-')[0];
                } else {
                    nav.href = `login.html?redirect=${encodeURIComponent(window.location.pathname + window.location.search)}`;
                }
            }

            // test func
            function increaseDescriptionSize(n=1500) { // max 2048
                const containers = document.querySelectorAll('.description');
                containers.forEach(div => {
                    var text = div.innerText;
                    console.log(text.length)
                    while (text.length < n) {
                        text = text + ' <i class="ri-chat-quote-line"></i> ' + text
                    }
                    div.innerHTML = '<i class="ri-chat-quote-line"></i> ' + text
                })
            }
            
            function ChangeAreaNav() {
                nav = document.getElementById('area-nav');
                redirect = encodeURIComponent(window.location.pathname + window.location.search);
                nav.href = 'area.html?redirect=' + redirect;
            }

            function normalizeURL(x,y,z,i,redirect) {
                const params = new URLSearchParams();

                params.set("xyzi", x+','+y+','+z+','+i);
                params.set("redirect", redirect)

                const newURL = `${window.location.pathname}?${params.toString()}`;

                window.history.replaceState({}, "", newURL);
            }

            function nonNegativeNumber(value, fallback) {
                const v = Number(value);
                return Number.isFinite(v) && v >= 0 ? v : fallback;
            }
            
            function getApiKeyFromCookie() {
                const match = document.cookie.match(/(?:^|; )X-API-Key=([^;]*)/);
                return match ? decodeURIComponent(match[1]) : null;
            }

            function buildCard(entity_data) {
                // Extend description length
                const char_quote = '<i class="ri-chat-quote-line"></i> ';
                const char_quote_long = ' '+char_quote;
                var description = entity_data.description;
                while (description.length < 1500) {
                    description = description + char_quote_long + description;
                }
                description = char_quote + description;

                const wrapper = document.createElement("div");
                wrapper.id = "entity_"+entity_data.iter;
                const tools = document.createElement("div"); // -- links iterator missing --
                const card = document.createElement("div");
                const iter_number = document.createElement("div");

                wrapper.className = "cardWrapper";
                tools.className = "tools holoshim";
                card.className = "card specular";
                iter_number.className = "iter-number";

                // to be continued TODO
            }

            function populateContainer(res) {
                const entity = res.entity;
                const entity_length = entity.length;
                const intended_iter = res.intended_iter;
                const is_latest = res.iter_is_latest;
                container.innerHTML = ''
                for (const key in entity) {
                    if (key == intended_iter-1 || key == intended_iter || key == intended_iter+1) {
                        const entity_data = entity[key];
                        container.appendChild(buildCard(entity_data));
                    } else {
                        continue
                    }
                }
            }

            function handleSuccess(res) {
                if (res?.entity) {
                    ChangeUserNav(res)
                    //populateContainer(res)
                    console.log(res)
                } else {
                    console.warn('Server did not respond with entity.')
                }

            }

            document.addEventListener("DOMContentLoaded", function () {
                // Setup;
                const apiKey = getApiKeyFromCookie();
                // Get params from location
                const params = new URLSearchParams(window.location.search);
                const xyzi = params.get('xyzi').split(','); // 
                const redirect = params.get('redirect');
                const xpos = Math.floor(nonNegativeNumber(xyzi[0] ?? 0, 0));
                const ypos = Math.floor(nonNegativeNumber(xyzi[1] ?? 0, 0));
                // Enforce [0,1,2,3,4,5,6,7] # 8 Zones
                const zone = Math.min(7, Math.max(0, Math.floor(nonNegativeNumber(xyzi[2] ?? 0, 0))));
                const ITER = Math.floor(nonNegativeNumber(xyzi[3] ?? 0, 0));

                normalizeURL(xpos, ypos, zone, ITER, redirect ?? 'area.html');
                ChangeAreaNav();

                RenderFactory("https://octo.shadowsword.ca/api/render/one", xpos, ypos, zone, ITER, apiKey)
                .done(function (res) {
                    handleSuccess(res)
                })
                .fail(function () {
                    RenderFactory("http://localhost:9300/api/render/one", xpos, ypos, zone, ITER, apiKey)
                    .done(function (res) {
                        handleSuccess(res)
                    })
                    .fail(function () {
                        console.warn('Server Com Failure')
                    })
                })

            })





        </script>
        

    </body>
</html>