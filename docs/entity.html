<!DOCTYPE html>
<html lang="en">
    <head>
        
        <title>Entity</title>
        <!-- https://remixicon.com/ -->
        <link
            href="https://cdn.jsdelivr.net/npm/remixicon@4.7.0/fonts/remixicon.css"
            rel="stylesheet"
        />
        <!-- favicon block -->
        <link rel="icon" type="image/png" sizes="512x512" href="favicon/android-chrome-512x512.png">
        <link rel="icon" type="image/png" sizes="192x192" href="favicon/android-chrome-192x192.png">
        <link rel="icon" type="image/png" sizes="32x32" href="favicon/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="favicon/favicon-16x16.png">
        <link rel="apple-touch-icon" href="favicon/apple-touch-icon.png">
        <link rel="alternate icon" href="favicon/favicon.ico">
        <!-- jquery block -->
        <script src="js/jquery-3.7.1.js"></script>

        <link rel="stylesheet" href="css/common.css">
        <link rel="stylesheet" href="css/map.css">
        <link rel="stylesheet" href="css/map_elements.css">
        <link rel="stylesheet" href="css/entity.css">

        <!-- Bots No Index No Follow -->
        <meta name="ROBOTS" content="NOINDEX,NOFOLLOW">

        <!-- For mobile support -->
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <meta name="theme-color" content="#3da79a">
        <meta property="og:site_name" content="Octo Application">
        <meta property="og:image" content="./img/about-bg.gif">
        <meta data-react-helmet="true" property="og:description" content="Lightweight repository project interacts with API Servers for a simple Data Library">    

    </head>
    <body>
        <div class="topnavigator">
            <div class="topleftbox">
                <div class="floating-right" id="loading"><div class="bouncing-loader"><div></div><div></div><div></div></div></div>
                
                <!-- Common -->
                <div class="topnavleft"><a href="index.html"><i class="ri-base-station-fill"></i> status</a></div>
                <div class="topnavleft"><a href="login.html?redirect=map.html" class="phasedBlue" id="user-login-nav"><i class="ri-passport-line"></i> login</a></div>
                <!-- Map View Navigation -->
                <div class="topnavleft"><a href="#" class="phasedYel" id="area-nav"><i class="ri-treasure-map-line"></i> area</a></div>
                <div class="topnavleft"><a href="#" class="phasedYel" onclick="safeExit()"><i class="ri-corner-down-left-fill"></i> Return</a></div>
                <div class="topnavleft"><a href="#" class="phasedYel" id="x_minus"><i class="ri-arrow-left-circle-line"></i> Back</a></div>
                <div class="topnavleft"><a href="#" class="phasedYel" id="x_plus"><i class="ri-arrow-right-circle-line"></i> Continue</a></div>

                <div class="skeleton-image" id="skeletonloading"></div>
            </div>
        </div>


        <div class="container" id="container">


            <div class="cardWrapper">

                <!-- TOP TOOLS -->
                <div class="tools holoshim">
                    <a><span><i class="ri-file-shred-fill"></i> rm</span></a>
                    |
                    <a><span><i class="ri-pencil-ai-fill"></i> edit</span></a>
                    |
                    <a><span><i class="ri-user-fill"></i> 00000000</span></a>
                    <div class="iter-number">#0</div>
                </div>

                
                    
                <!-- SHADER LAYER -->
                <div class="card specular">
                    <div class="cell-bar" style="position: absolute; top: 250px;"></div>
                    <div class="cell-bar" style="position: absolute; top: 450px;"></div>
                    <!-- INNER CARD CONTENTS ///////////////////////////// -->
                    <div class="content wordbreak" style="word-break: break-all;">
                        <div class="description">
                            I am the wind through the leaves,
                            I am the wave on the sea,
                            I am the murmur of the willows,
                            I am the crow upon the rocks,
                            I am a beam of sun,
                            I am the fairest of plants,
                            I am the wild stag of the forest,
                            I am the grass in the fields,
                            I am the word of knowledge.
                            Who is it who listens to the trees?
                            Who announces the ages of the moon?
                            Who remembers the old ways,
                            If not I?
                        </div>
                        <!-- CARD UUID AT BOTTOM OF CARD (CUTS OFF TEXT)-->
                        <div class="cardID">
                            <span><i class="ri-focus-2-line"></i>de0d16af-a0fa-4c6c-9616-0d4b431d1835</span> 
                        </div>
                    </div>
                    <!-- (END) INNER CARD CONTENTS /////////////////////// -->

                    <!-- Central Elements -->
                    <div class="cardCenter">
                        <div class="bouncing-loader"><div></div><div></div><div></div></div>
                        <div class="ts">
                            --:--:--:--
                        </div>
                    </div>

                    <div>
                        <!-- Glyph Elements -->
                        <div class="glyph-top topElements">
                            <div class="glyph-slot glyph-actual">ð“…“</div>
                            <div class="glyph-slot glyph-actual">ð“…“</div>
                            <div class="glyph-slot glyph-actual">ð“…“</div>
                            <div class="glyph-slot glyph-actual">ð“…“</div>
                            <!-- Mint Area-->
                            <div class="glyph-slot holoshim" style="font-size: 30px;">
                                <i class="ri-copper-coin-fill"></i>
                            </div>
                        </div>

                        <div class="glyph-bottom bottomElements">
                            <div class="glyph-slot glyph-actual">ð“…“</div>
                            <div class="glyph-slot glyph-actual">ð“…“</div>
                            <div class="glyph-slot glyph-actual">ð“…“</div>
                            <div class="glyph-slot glyph-actual">ð“…“</div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <script type="text/javascript">

            const container = document.getElementById('container');
            let entity;
            let currentIter = null;
            //var selected = 0;

            function updateTS(e) {
                if (!e) return;

                // Read raw dataset value and coerce to a finite number (seconds)
                const raw = e.dataset?.ts;
                const rawNum = Number(raw);
                const ts = Number.isFinite(rawNum) ? rawNum * 1000 : 0;

                if (ts === 0) {
                    e.innerHTML = "--:--:--:--";
                } else {
                    let diff = (Date.now() - ts) / 1000;
                    const days = Math.floor(diff / 86400);
                    const hours = Math.floor((diff % 86400) / 3600);
                    const minutes = Math.floor((diff % 3600) / 60);
                    const seconds = Math.floor(diff % 60);
                    e.innerHTML = `${days}d:${hours}h:${minutes}m:${seconds}s`;
                }

                requestAnimationFrame(() => updateTS(e));
            }

            function safeRedirect(path) {
                if (path && path.startsWith("/") && !path.startsWith("//")) {
                    window.location.href = path;
                } else {
                    window.location.href = "./index.html";
                }
            };

            function safeExit() {
                const params = new URLSearchParams(window.location.search);
                const redirectTo = params.get("redirect") || "./index.html";
                safeRedirect(redirectTo);
            };

            function RenderFactory(url, x, y, z, i, apikey=null) {
                return $.ajax({
                    type: "POST",
                    url: url,
                    timeout: 1500,
                    contentType: "application/json",
                    dataType: "json",
                    headers: apikey ? { "X-API-Key": apikey } : {},
                    data: JSON.stringify({ 'x_pos': x, 'y_pos': y, 'zone': z, 'iter': i })
                })
            }

            function illuminate(list_of_colors) {
                list_of_colors.forEach((value, i) => {
                    document.documentElement.style.setProperty(`--banner-channel-${i}`, value);
                });
            }

            function ChangeUserNav(res) {
                nav = document.getElementById('user-login-nav');
                if (res.user_context.decryption_success) {
                    redirect = encodeURIComponent(window.location.pathname + window.location.search);
                    nav.href = 'user.html?redirect=' + redirect; // This will point to the user page
                    nav.innerHTML = '<i class="ri-passport-fill"></i> ' + String(res.user_context.ID).split('-')[0];
                } else {
                    nav.href = `login.html?redirect=${encodeURIComponent(window.location.pathname + window.location.search)}`;
                }
            }
            
            function ChangeAreaNav() {
                nav = document.getElementById('area-nav');
                redirect = encodeURIComponent(window.location.pathname + window.location.search);
                nav.href = 'area.html?redirect=' + redirect;
            }

            function normalizeURL(x,y,z,i,redirect) {
                const params = new URLSearchParams();

                params.set("xyzi", x+','+y+','+z+','+i);
                params.set("redirect", redirect)

                const newURL = `${window.location.pathname}?${params.toString()}`;

                window.history.replaceState({}, "", newURL);
            }

            function nonNegativeNumber(value, fallback) {
                const v = Number(value);
                return Number.isFinite(v) && v >= 0 ? v : fallback;
            }
            
            function getApiKeyFromCookie() {
                const match = document.cookie.match(/(?:^|; )X-API-Key=([^;]*)/);
                return match ? decodeURIComponent(match[1]) : null;
            }

            function launch_error_toast(error_text) {
                var t = document.getElementById("error_toast")
                var d = document.getElementById("error_desc")
                t.className = "show";
                d.innerText = error_text;
                setTimeout(function(){ t.className = t.className.replace("show", ""); }, 5000);
            }

            function applyChannelAnimation(pad, bar) {
                if (!bar || typeof bar !== "object") return;

                const channels = Object.values(bar); // channel_0 â†’ channel_7

                channels.forEach((c, i) => {
                    pad.style.setProperty(`--c${i}`, c);
                });

                // First 4 drive the background animation
                for (let i = 0; i < 4; i++) {
                    pad.style.setProperty(`--ch-${i}`, channels[i % channels.length]);
                }
            }

            function buildCard(entity_data, key) {
                // Extend description length
                const char_quote = '<i class="ri-chat-quote-line"></i> ';
                const char_quote_long = ' '+char_quote;
                var description = entity_data.description;
                while (description.replaceAll(char_quote_long, '').length < 1500) {
                    description = description + char_quote_long + description;
                }
                description = char_quote + description;

                // wrapper setup
                const wrapper = document.createElement("div");
                wrapper.className = "cardWrapper";
                wrapper.id = "entity_"+entity_data.iter;

                // tools setup
                const tools = document.createElement("div");
                tools.className = "tools holoshim";
                
                const tools_rm = document.createElement("a")
                tools_rm.innerHTML = '<span><i class="ri-file-shred-fill"></i> rm</span>'

                const tools_edit = document.createElement("a")
                tools_edit.innerHTML = '<span><i class="ri-pencil-ai-fill"></i> edit</span>'

                const tools_history = document.createElement("a");
                tools_history.innerHTML = '<span><i class="ri-time-line"></i> history</span>'

                const tools_user = document.createElement("a");
                const ownership = entity_data.ownership ?? '00000000';
                tools_user.innerHTML = `<span><i class="ri-user-fill"></i> ${ownership.split('-')[0]}</span>`;

                // card setup
                const card = document.createElement("div");
                card.className = "card specular";
                
                const bar_colors = entity_data.aesthetics?.bar;
                const channels = Object.values(bar_colors);
                card.style.setProperty("--spec-channel", channels[7]);
                // TODO Maybe a darkened version of the color for the bg element instead of gray?
                
                const iter_number = document.createElement("div");
                iter_number.className = "iter-number";
                iter_number.innerText = '#' + key ?? '0';

                const cellbar_top = document.createElement("div");
                cellbar_top.className = "cell-bar";
                cellbar_top.style.setProperty('position', 'absolute');
                cellbar_top.style.setProperty('top', '260px');

                const cellbar_bottom = document.createElement("div");
                cellbar_bottom.className = "cell-bar";
                cellbar_bottom.style.setProperty('position', 'absolute');
                cellbar_bottom.style.setProperty('top', '525px');

                const base_layer = document.createElement("div");
                base_layer.className = "content";
                base_layer.style.setProperty("word-break", "break-all");

                const description_layer = document.createElement("div");
                description_layer.innerHTML = description;

                const central_element = document.createElement("div");
                central_element.className ="cardCenter";
                const ts_area = document.createElement("div")
                ts_area.className = "ts";
                // For now we'll leave the timestamp default blank, animate later
                ts_area.innerText = '--:--:--:--';
                ts_area.dataset.ts = entity_data.timestamp;

                updateTS(ts_area);

                // Card's db entity UUID
                const card_id = document.createElement("div");
                card_id.className = "cardID";
                const id_actual = document.createElement("span");
                id_actual.innerHTML = '<i class="ri-focus-2-line"></i>' + entity_data.uuid;

                // Glyphs & Minted Indicator
                const glyph_elements = document.createElement("div");
                const top = document.createElement("div");
                top.className = "glyph-top topElements";
                const bottom = document.createElement("div");
                bottom.className = "glyph-bottom bottomElements";

                const mint_shim = document.createElement("div");
                mint_shim.className = "glyph-slot holoshim";
                mint_shim.style.setProperty("font-size", "30px");
                if (entity_data.minted == true) {
                    mint_shim.innerHTML = '<i class="ri-copper-coin-fill"></i>';
                } else {
                    mint_shim.innerHTML = '<i class="ri-copper-coin-line"></i>'
                }
                
                const glyphs = Object.values(entity_data.aesthetics?.glyphs || {});
                glyphs.slice(0, 8).forEach((g, i) => {
                    const d = document.createElement("div");
                    d.className = "glyph-slot glyph-actual";
                    d.textContent = g;

                    d.style.setProperty("--glyph-ch", i);
                    d.style.animationDelay = `${i * 0.2}s`;
                    
                    if (i < 4) top.appendChild(d);
                    else bottom.appendChild(d);
                })

                channels.forEach((c, i) => {
                    const ch = document.createElement("div");
                    const next = channels[(i + 1) % channels.length];
                    ch.style.setProperty('--xch0', c);
                    ch.style.setProperty('--xch1', next);
                    ch.className = 'ent-el';
                    if (i < 4) {
                        cellbar_top.appendChild(ch)
                    } else {
                        cellbar_bottom.appendChild(ch)
                    }  
                })

                applyChannelAnimation(glyph_elements, entity_data.aesthetics?.bar);

                // assembly
                
                top.appendChild(mint_shim);
                glyph_elements.append(top, bottom);

                tools.append(tools_rm, ' | ', tools_edit, ' | ', tools_history, ' | ', tools_user, iter_number);
                wrapper.append(tools);

                central_element.append(entity_data.name, ts_area)
                card_id.append(id_actual);
                base_layer.append(description_layer, card_id);
                card.append(base_layer, central_element, glyph_elements);
                wrapper.append(card, cellbar_top, cellbar_bottom);

                return wrapper;
            }

            function populateContainer(res) {
                entity = res.entity;

                const intended_iter = Number(res.intended_iter);
                currentIter = Number.isFinite(intended_iter) ? intended_iter : null;

                container.innerHTML = '';
                renderCurrentCard();
            }

            function renderCurrentCard() {
                if (!entity || currentIter === null) {
                    launch_error_toast('No entity loaded.');
                    return;
                }

                const data = entity[currentIter];
                if (data) {
                    container.innerHTML = '';
                    container.appendChild(buildCard(data, currentIter));
                } else {
                    launch_error_toast('No card available for this iteration.');
                }
            }

            function handleSuccess(res) {
                if (res?.entity) {
                    ChangeUserNav(res)
                    populateContainer(res)
                    console.log(res)
                } else {
                    console.warn('Server did not respond with entity.')
                    launch_error_toast(res?.db_health?.message || "Unexpected error occurred.")
                }

            }

            document.addEventListener("DOMContentLoaded", function () {
                // Setup;
                const apiKey = getApiKeyFromCookie();
                // Navigation handlers for Back / Continue
                const backBtn = document.getElementById('x_minus');
                const nextBtn = document.getElementById('x_plus');

                if (backBtn) {
                    backBtn.addEventListener('click', function (ev) {
                        ev.preventDefault();
                        if (!entity || currentIter === null) return launch_error_toast('No entity loaded.');
                        const prev = Number(currentIter) - 1;
                        if (prev >= 0 && entity[prev]) {
                            currentIter = prev;
                            renderCurrentCard();
                        } else {
                            launch_error_toast('No previous card available.');
                        }
                    });
                }

                if (nextBtn) {
                    nextBtn.addEventListener('click', function (ev) {
                        ev.preventDefault();
                        if (!entity || currentIter === null) return launch_error_toast('No entity loaded.');
                        const nxt = Number(currentIter) + 1;
                        if (entity[nxt]) {
                            currentIter = nxt;
                            renderCurrentCard();
                        } else {
                            launch_error_toast('No next card available.');
                        }
                    });
                }
                // Get params from location
                const params = new URLSearchParams(window.location.search);
                const xyzi = (params.get('xyzi') ?? '0,0,0,0').split(',');
                const redirect = params.get('redirect');
                const xpos = Math.floor(nonNegativeNumber(xyzi[0] ?? 0, 0));
                const ypos = Math.floor(nonNegativeNumber(xyzi[1] ?? 0, 0));
                // Enforce [0,1,2,3,4,5,6,7] # 8 Zones
                const zone = Math.min(7, Math.max(0, Math.floor(nonNegativeNumber(xyzi[2] ?? 0, 0))));
                const ITER = Math.floor(nonNegativeNumber(xyzi[3] ?? 0, 0));

                normalizeURL(xpos, ypos, zone, ITER, redirect ?? 'area.html');
                ChangeAreaNav();

                RenderFactory("https://octo.shadowsword.ca/api/render/one", xpos, ypos, zone, ITER, apiKey)
                .done(function (res) {
                    handleSuccess(res)
                })
                .fail(function () {
                    RenderFactory("http://localhost:9300/api/render/one", xpos, ypos, zone, ITER, apiKey)
                    .done(function (res) {
                        handleSuccess(res)
                    })
                    .fail(function () {
                        console.warn('Server Com Failure')
                    })
                })

            })





        </script>
        
        <div id="error_toast"><div id="icon"><i class="ri-signal-wifi-error-line"></i></div><div id="error_desc"></div></div>
    </body>
</html>