<!DOCTYPE html>
<html lang="en">
    <head>
        
        <title>Area Select</title>
        <!-- https://remixicon.com/ -->
        <link
            href="https://cdn.jsdelivr.net/npm/remixicon@4.7.0/fonts/remixicon.css"
            rel="stylesheet"
        />
        <!-- favicon block -->
        <link rel="icon" type="image/png" sizes="512x512" href="favicon/android-chrome-512x512.png">
        <link rel="icon" type="image/png" sizes="192x192" href="favicon/android-chrome-192x192.png">
        <link rel="icon" type="image/png" sizes="32x32" href="favicon/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="favicon/favicon-16x16.png">
        <link rel="apple-touch-icon" href="favicon/apple-touch-icon.png">
        <link rel="alternate icon" href="favicon/favicon.ico">
        <!-- jquery block -->
        <script src="js/jquery-3.7.1.js"></script>

        <link rel="stylesheet" href="css/common.css">
        <link rel="stylesheet" href="css/map.css">
        <link rel="stylesheet" href="css/map_elements.css">

        <!-- Bots No Index No Follow -->
        <meta name="ROBOTS" content="NOINDEX,NOFOLLOW">

        <!-- For mobile support -->
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <meta name="theme-color" content="#3da79a">
        <meta property="og:site_name" content="Octo Application">
        <meta property="og:image" content="./img/about-bg.gif">
        <meta data-react-helmet="true" property="og:description" content="Lightweight repository project interacts with API Servers for a simple Data Library">    

    </head>
    <body>
        <div class="topnavigator">
            <div class="topleftbox">
                <div class="floating-right" id="loading"><div class="bouncing-loader"><div></div><div></div><div></div></div></div>
                
                <!-- Common -->
                <div class="topnavleft"><a href="index.html"><i class="ri-base-station-fill"></i> status</a></div>
                <div class="topnavleft"><a href="login.html?redirect=area.html" class="phasedBlue" id="user-login-nav"><i class="ri-passport-line"></i> login</a></div>
                <div class="topnavleft"><a href="#" class="phasedYel" onclick="safeExit()"><i class="ri-corner-down-left-fill"></i> Return</a></div>
                <div class="topnavleft"><a href="#" class="phased"><i class="ri-compass-discover-line"></i> search</a></div> <!-- Currently Unused -->

                <div class="skeleton-image" id="skeletonloading"></div>
            </div>
        </div>
        <div class="container" id="grid">
            <!-- Content -->
        </div>

    <script type="text/javascript">
        const grid = document.getElementById("grid");

        function safeRedirect(path) {
            if (path && path.startsWith("/") && !path.startsWith("//")) {
                window.location.href = path;
            } else {
                window.location.href = "./index.html";
            }
        };

        function safeExit() {
            const params = new URLSearchParams(window.location.search);
            const redirectTo = params.get("redirect") || "./index.html";
            safeRedirect(redirectTo);
        };
        
        function ChangeUserNav(res) {
            nav = document.getElementById('user-login-nav');
            if (res.user_context.decryption_success) {
                redirect = encodeURIComponent(window.location.pathname + window.location.search);
                nav.href = 'user.html?redirect=' + redirect; // This will point to the user page
                nav.innerHTML = '<i class="ri-passport-fill"></i> ' + String(res.user_context.ID).split('-')[0];
            } else {
                nav.href = `login.html?redirect=${encodeURIComponent(window.location.pathname + window.location.search)}`;
            }
        }

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function illuminate(colors) {
            b = shuffle(colors);
            b.forEach((value, i) => {
                document.documentElement.style.setProperty(`--banner-channel-${i}`, value);
            });
        }

        function applyChannelAnimation(pad, bar) {
            if (!bar || typeof bar !== "object") return;

            const channels = Object.values(bar); // channel_0 → channel_7

            channels.forEach((c, i) => {
                pad.style.setProperty(`--c${i}`, c);
            });

            // First 4 drive the background animation
            for (let i = 0; i < 4; i++) {
                pad.style.setProperty(`--ch-${i}`, channels[i % channels.length]);
            }
        }

        /* Navigate to Entity : Build the URL component, execute on click */
        function NavigateToEntity(entity) {
            const redirect = encodeURIComponent(window.location.pathname + window.location.search);
            window.location.href = `map.html?x=`+entity.repr.x+`&y=`+entity.repr.y+'&z='+entity.positionZ+'&redirect='+redirect;
        }
        
        function toggleLoadingBar(force, loadingID='loading') {
            const loading = document.getElementById(loadingID);

            if (force !== undefined) {
                // If force is provided, explicitly set display
                loading.style.display = force ? 'block' : 'none';
            } else {
                // Otherwise, toggle
                loading.style.display = (loading.style.display === 'none') ? 'block' : 'none';
            }
        }

        function buildCell(entity) {
            const cell = document.createElement("div");
            cell.className = "cell";
            cell.dataset.state = entity.state ?? 0;

            const pad = document.createElement("div");
            pad.className = "cell-pad";

            // ✅ correct channel handling
            applyChannelAnimation(pad, entity.aesthetics?.bar);

            const seed = parseInt(entity.uuid?.replace(/-/g, "").slice(0, 6), 16) || 0;
            pad.style.animationDelay = `${-(seed % 1200) / 100}s`;

            const inner = document.createElement("div");
            inner.className = "cell-inner";

            const top = document.createElement("div");
            top.className = "glyph-top";

            const bottom = document.createElement("div");
            bottom.className = "glyph-bottom";

            const glyphs = Object.values(entity.aesthetics?.glyphs || {});
            glyphs.slice(0, 8).forEach((g, i) => {
                const d = document.createElement("div");
                d.className = "glyph-slot";
                if (i == 7) {
                    d.style=("cursor: pointer");
                    d.className = "glyph-slot NavElement"
                    d.onclick = () => NavigateToEntity(entity);
                }
                d.textContent = g;

                d.style.setProperty("--glyph-ch", i);
                d.style.animationDelay = `${i * 0.2}s`;

                if (i < 4) top.appendChild(d);
                else bottom.appendChild(d);
            });

            const center = document.createElement("div");
            center.className = "center extrusionbase";

            const uuid = document.createElement("div");
            uuid.className = "uuid";
            uuid.textContent = `${entity.uuid.slice(0, 8)} --`;

            const owner = document.createElement("div");
            owner.className = "owner";
            owner.textContent = `x${entity.repr.x},y${entity.repr.y},z${entity.positionZ}`

            // extrusion tooltip with hidden timestamp
            const extrusion = document.createElement("div");
            extrusion.className = "extrude";

            const display = document.createElement("div");
            //display.href = "#";
            display.textContent = `${entity.repr.s}`;
            extrusion.appendChild(display);

            const channels = Object.values(entity.aesthetics?.bar);
            const CellBar = document.createElement("div");
            CellBar.className = "cell-bar";

            channels.forEach((c, i) => {
                const next = channels[(i + 1) % channels.length];
                const BarEl = document.createElement("div");
                BarEl.style.setProperty(`--xch0`, c)
                BarEl.style.setProperty(`--xch1`, next)
                BarEl.className = "bar-el";
                CellBar.append(BarEl)
            })
            extrusion.append(CellBar);

            //requestAnimationFrame(updateExtrusion);

            center.append(uuid, owner, extrusion);
            inner.append(top, center, bottom);
            pad.append(inner);
            cell.append(pad);

            return cell;
        }


        function populateGrid(response) {
            grid.innerHTML = "";

            if (response?.entities) {
                for (let e = 0; e < response.entities.length; e++) {
                    grid.appendChild(buildCell(response.entities[e]))
                }
            }
        }

        function RenderFactory(url, xyzs, apikey=null) {
            return $.ajax({
                type: "POST",
                url: url,
                timeout: 1500,
                contentType: "application/json",
                dataType: "json",
                headers: apikey ? { "X-API-Key": apikey } : {},
                data: JSON.stringify({ 'xyzs': xyzs })
            })
        }

        function launch_error_toast(error_text) {
            var t = document.getElementById("error_toast")
            var d = document.getElementById("error_desc")
            t.className = "show";
            d.innerText = error_text;
            setTimeout(function(){ t.className = t.className.replace("show", ""); }, 5000);
        }

        function getApiKeyFromCookie() {
            const match = document.cookie.match(/(?:^|; )X-API-Key=([^;]*)/);
            return match ? decodeURIComponent(match[1]) : null;
        }
        
        document.addEventListener("DOMContentLoaded", function () {
            const apiKey = getApiKeyFromCookie();

            // Areas of interest are defined here.
            const toLoad = [
                "0,0,0,Main Area",
                "0,0,1,Main Area",
                "0,0,2,Main Area",
                "0,0,3,Main Area",
                "0,0,4,Main Area",
                "0,0,5,Main Area",
                "0,0,6,Main Area",
                "0,0,7,Main Area",
                "0,0,8,Main Area",
                "0,0,9,Main Area",
                "0,0,10,Main Area",
                "0,0,11,Main Area",
                "0,0,12,Main Area",
                "0,0,13,Main Area",
                "0,0,14,Main Area",
                "0,0,15,Main Area",
                "64,64,5,Sacred Area",
                "64,64,4,Sacred Area",
                "64,64,1,Sacred Area",
                "2,6,2,Temple of Snakes"
            ]

            RenderFactory("https://octo.shadowsword.ca/api/render/areas", toLoad, apiKey)
            .done(function (res) {
                console.log(res)
                if (res?.entities) {
                    populateGrid(res)
                    ChangeUserNav(res)
                    toggleLoadingBar(false)
                    toggleLoadingBar(false, 'skeletonloading')
                    illuminate([
                        '#1F1A2B',        '#211735',        '#250F46',
                        '#362A55',        '#4F3A87',        '#5828A6',
                        '#5F10B8',        '#7434E0',        '#782AEA',
                        '#7C17F4',        '#732ff6',        '#7657eb',
                        '#7972df',        '#7e89d2',        '#849dc4',
                        '#8bb1b3',        '#93c3a0',        '#9cd488',
                        '#a5e569',        '#aff631'
                    ])
                } else {
                    toggleLoadingBar(false)
                    launch_error_toast(res?.db_health?.message || "Unexpected error occurred.")
                }
            })
            .fail(function () {
                console.warn("Couldn't establish DNS connection, falling back to localhost.")
                RenderFactory("http://localhost:9300/api/render/areas", toLoad, apiKey)
                .done(function (res) {
                    console.log(res)
                    if (res?.entities) {
                        populateGrid(res)
                        ChangeUserNav(res)
                        toggleLoadingBar(false)
                        toggleLoadingBar(false, 'skeletonloading')
                        illuminate([
                            '#7489c9',
                            '#375c67',
                            '#34b768',
                            '#732ff6',
                            '#aff631',
                            '#cea34c',
                            '#7C17F4',
                            "#FF906E"
                        ])
                    } else {
                        toggleLoadingBar(false)
                        launch_error_toast(res?.db_health?.message || "Unexpected error occurred.")
                    }

                })
                .fail(function () {
                    toggleLoadingBar(false)
                    launch_error_toast("Cannot establish server connection.")
                })
            })
        })
    </script>

    <div id="error_toast"><div id="icon"><i class="ri-signal-wifi-error-line"></i></div><div id="error_desc"></div></div>
    </body>
</html>