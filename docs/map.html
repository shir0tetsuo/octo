<!DOCTYPE html>
<html lang="en">
    <head>
        
        <title>Map</title>
        <!-- https://remixicon.com/ -->
        <link
            href="https://cdn.jsdelivr.net/npm/remixicon@4.7.0/fonts/remixicon.css"
            rel="stylesheet"
        />
        <link rel="icon" type="image/png" sizes="512x512" href="favicon/android-chrome-512x512.png">
        <link rel="icon" type="image/png" sizes="192x192" href="favicon/android-chrome-192x192.png">
        <link rel="icon" type="image/png" sizes="32x32" href="favicon/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="favicon/favicon-16x16.png">
        <link rel="apple-touch-icon" href="favicon/apple-touch-icon.png">
        <link rel="alternate icon" href="favicon/favicon.ico">

        <script src="js/jquery-3.7.1.js"></script>

        <link rel="stylesheet" href="css/map.css">
        <link rel="stylesheet" href="css/common.css">

        <!-- Bots No Index No Follow -->
        <meta name="ROBOTS" content="NOINDEX,NOFOLLOW">

        <!-- For mobile support -->
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <meta name="theme-color" content="#3da79a">
        <meta property="og:site_name" content="Octo Application">
        <meta property="og:image" content="./img/about-bg.gif">
        <meta data-react-helmet="true" property="og:description" content="Lightweight repository project interacts with API Servers for a simple Data Library">    

    </head>
    <body>
        <div class="topnavigator">
            <div class="topleftbox">
                <div class="floating-right" id="loading">
                    <div class="bouncing-loader">
                        <div></div>
                        <div></div>
                        <div></div>
                    </div>
                </div>
                <div class="topnavleft">
                    <a href="index.html">
                        <i class="ri-base-station-fill"></i> status
                    </a>
                </div>
                <div class="topnavleft">
                    <a href="login.html?redirect=map.html" class="phasedBlue" id="user-login-nav">
                        <i class="ri-passport-line"></i> login
                    </a>
                </div>
                <div class="topnavleft">
                    <a href="#" class="phasedYel">
                        <i class="ri-treasure-map-line"></i> area
                    </a>
                </div>
                <div class="topnavleft">
                    <a href="#" class="phasedYel" id="x_minus">
                        <i class="ri-arrow-left-circle-line"></i> X-
                    </a>
                </div>
                <div class="topnavleft">
                    <a href="#" class="phasedYel" id="x_plus">
                        <i class="ri-arrow-right-circle-line"></i> X+
                    </a>
                </div>
                <div class="topnavleft">
                    <a href="#" class="phasedYel" id="y_minus">
                        <i class="ri-arrow-down-circle-line"></i> Y-
                    </a>
                </div>
                <div class="topnavleft">
                    <a href="#" class="phasedYel" id="y_plus">
                        <i class="ri-arrow-up-circle-line"></i> Y+
                    </a>
                </div>
                <div class="topnavleft">
                    <a href="#" class="phased">
                        <i class="ri-compass-discover-line"></i> search
                    </a>
                </div>

                <div class="skeleton-image" id="skeletonloading"></div>
            </div>
        </div>
        <div class="container" id="grid">
            <!-- TODO : Content, Loading -->
        </div>


        <script type="text/javascript">

            // Cell Building

            const grid = document.getElementById("grid");

            function applyChannelAnimation(pad, channels) {
                const keys = Object.keys(channels || {});
                if (!keys.length) return;

                // Use first 4 channels (or wrap)
                for (let i = 0; i < 4; i++) {
                    pad.style.setProperty(
                        `--ch-${i}`,
                        channels[keys[i % keys.length]]
                    );
                }
            }

            function buildCell(entity) {
                const cell = document.createElement("div");
                cell.className = "cell";
                cell.dataset.state = entity.state ?? 0;

                const pad = document.createElement("div");
                pad.className = "cell-pad";

                applyChannelAnimation(pad, entity.aesthetics?.bar);

                const seed = parseInt(entity.uuid?.replace(/-/g, "").slice(0, 6), 16) || 0;
                pad.style.animationDelay = `${-(seed % 1200) / 100}s`;

                // optional: per-entity channel animation
                if (entity.channels?.length) {
                    pad.style.animation = "none";
                    pad.style.background = entity.channels[0];
                }

                const inner = document.createElement("div");
                inner.className = "cell-inner";

                const top = document.createElement("div");
                top.className = "glyph-top";

                const bottom = document.createElement("div");
                bottom.className = "glyph-bottom";

                (entity.glyphs || []).slice(0,4).forEach(g => {
                    const d = document.createElement("div");
                    d.className = "glyph-slot";
                    d.textContent = g;
                    top.appendChild(d);
                });

                (entity.glyphs || []).slice(4,8).forEach(g => {
                    const d = document.createElement("div");
                    d.className = "glyph-slot";
                    d.textContent = g;
                    bottom.appendChild(d);
                });

                const center = document.createElement("div");
                center.className = "center";

                const uuid = document.createElement("div");
                uuid.className = "uuid";
                uuid.textContent = entity.uuid.slice(0, 8);

                const owner = document.createElement("div");
                owner.className = "owner";
                owner.textContent = entity.owner ?? "00000000";

                center.append(uuid, owner);
                inner.append(top, center, bottom);
                pad.append(inner);
                cell.append(pad);

                return cell;
            }

            function populateGrid(entityRows) {
                grid.innerHTML = "";

                for (let y = 0; y < 8; y++) {
                    const row = entityRows[y];
                    if (!row) continue;

                    for (let x = 0; x < 8; x++) {
                        const entity = row[x];
                        grid.appendChild(buildCell(entity));
                    }
                }
            }


            // Factory Functions

            function RenderFactory(url, x, y, z, apikey=null) {
                return $.ajax({
                    type: "POST",
                    url: url,
                    timeout: 3000,
                    contentType: "application/json",
                    dataType: "json",
                    headers: apikey ? { "X-API-Key": apikey } : {},
                    data: JSON.stringify({ 'x_axis': x, 'y_axis': y, 'z_axis': z, 'time_axis': null })
                })
            }

            function positiveNumber(params, param, fallback) {
                const v = Number(params.get(param));
                return Number.isFinite(v) && v > 0 ? v : fallback;
            }

            function nonNegativeNumber(params, param, fallback) {
                const v = Number(params.get(param));
                return Number.isFinite(v) && v >= 0 ? v : fallback;
            }

            function normalizeURL(x, y, z) {
                const params = new URLSearchParams();

                params.set("x", x);
                params.set("y", y);
                params.set("z", z);

                const newURL = `${window.location.pathname}?${params.toString()}`;

                window.history.replaceState({}, "", newURL);
            }

            function buildURL(x, y, z) {
                const params = new URLSearchParams({
                    x: x,
                    y: y,
                    z: z
                });

                return `${window.location.pathname}?${params.toString()}`;
            }

            function updateNavLinks(x, y, z) {
                $("#x_plus").attr("href", buildURL(x + 1, y, z));
                $("#x_minus").attr("href", buildURL(Math.max(0, x - 1), y, z));

                $("#y_plus").attr("href", buildURL(x, y + 1, z));
                $("#y_minus").attr("href", buildURL(x, Math.max(0, y - 1), z));
            }

            function getApiKeyFromCookie() {
                const match = document.cookie.match(/(?:^|; )X-API-Key=([^;]*)/);
                return match ? decodeURIComponent(match[1]) : null;
            }

            function toggleLoadingBar(force, loadingID='loading') {
                const loading = document.getElementById(loadingID);

                if (force !== undefined) {
                    // If force is provided, explicitly set display
                    loading.style.display = force ? 'block' : 'none';
                } else {
                    // Otherwise, toggle
                    loading.style.display = (loading.style.display === 'none') ? 'block' : 'none';
                }
            }

            function launch_error_toast(error_text) {
                var t = document.getElementById("error_toast")
                var d = document.getElementById("error_desc")
                t.className = "show";
                d.innerText = error_text;
                setTimeout(function(){ t.className = t.className.replace("show", ""); }, 5000);
            }

            function shuffle(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }

            function illuminate(res) {
                b = shuffle(res.banner);
                document.documentElement.style.setProperty('--banner-channel-0', b[0]);
                document.documentElement.style.setProperty('--banner-channel-1', b[1]);
                document.documentElement.style.setProperty('--banner-channel-2', b[2]);
                document.documentElement.style.setProperty('--banner-channel-3', b[3]);
                document.documentElement.style.setProperty('--banner-channel-4', b[4]);
                document.documentElement.style.setProperty('--banner-channel-5', b[5]);
                document.documentElement.style.setProperty('--banner-channel-6', b[6]);
                document.documentElement.style.setProperty('--banner-channel-7', b[7]);
            }

            function ChangeUserNav(res) {
                nav = document.getElementById('user-login-nav');
                if (res.user_context.decryption_success) {
                    nav.href = '#'; // This will point to the user page
                    nav.innerHTML = '<i class="ri-passport-fill"></i> ' + String(res.user_context.ID).split('-')[0];
                } else {
                    nav.href = `login.html?redirect=${encodeURIComponent(window.location.pathname + window.location.search)}`;
                }
            }

            document.addEventListener("DOMContentLoaded", function () {

                // Get params from location
                const params = new URLSearchParams(window.location.search);

                const xpos = Math.floor(nonNegativeNumber(params, 'x', 0));
                const ypos = Math.floor(nonNegativeNumber(params, 'y', 0));
                // Enforce [0,1,2,3,4,5,6,7]
                const zone = Math.min(7, Math.max(0, Math.floor(nonNegativeNumber(params, 'z', 0))));

                const apiKey = getApiKeyFromCookie();

                console.log(xpos, ypos, zone, apiKey)

                // normalize & update navigation
                normalizeURL(xpos, ypos, zone);
                updateNavLinks(xpos, ypos, zone);

                // Load Data from Server
                RenderFactory("https://octo.shadowsword.ca/api/render", xpos, ypos, zone, apiKey)
                .done(function (res) {
                    console.log(res)
                    if (res.message == "OK") {
                        illuminate(res)
                        ChangeUserNav(res)
                        populateGrid(res.entities)
                        toggleLoadingBar(false) // for now, before we get into real data loading
                        toggleLoadingBar(false, 'skeletonloading')
                    }
                    
                })
                .fail(function () {
                    // fallback
                    console.warn("Couldn't establish DNS connection, falling back to localhost.")
                    RenderFactory("http://localhost:9300/api/render", xpos, ypos, zone)
                    .done(function (res) {
                        console.log(res)
                        if (res.message == "OK") {
                            illuminate(res)
                            ChangeUserNav(res)
                            populateGrid(res.entities)
                            toggleLoadingBar(false) // for now, before we get into real data loading
                            toggleLoadingBar(false, 'skeletonloading')
                        }
                        
                    })
                    .fail(function () {
                        // Cannot load page, display Error Message
                        console.warn('Cannot establish server connection.')
                        launch_error_toast('Cannot establish server connection.')
                        toggleLoadingBar(false)
                        toggleLoadingBar(false, 'skeletonloading')
                    });
                });

            });


        </script>

        <style>
            html, body {
                margin: 0;
                padding: 0;
                height: 100%;
                background: #0a0a0a;
                overflow: hidden;
                font-family: monospace;
            }

            /* ===== GRID ===== */
            #grid {
                display: grid;
                grid-template-columns: repeat(8, 1fr);
                grid-template-rows: repeat(8, 1fr);
                margin: auto;
            }

            /* ===== CELL ===== */
            .cell {
                box-sizing: border-box;
                border: 2px solid #555; /* default (state 0) */
                display: flex;
            }

            /* state-based borders */
            .cell[data-state="1"] { border-color: #00ffff; }
            .cell[data-state="2"] { border-color: #ff00ff; }
            .cell[data-state="3"] { border-color: #ffaa00; }

            /* ===== ANIMATED CHANNEL BACKGROUND ===== */
            .cell-pad {
                padding-top: 8px;
                opacity: 0.9;
                flex: 1;
                display: flex;

                /* Layered gradients */
                background:
                    radial-gradient(
                        circle at 30% 30%,
                        color-mix(in srgb, var(--ch-0) 70%, black 30%),
                        transparent 60%
                    ),
                    radial-gradient(
                        circle at 70% 70%,
                        color-mix(in srgb, var(--ch-2) 70%, black 30%),
                        transparent 65%
                    ),
                    linear-gradient(
                        120deg,
                        var(--ch-0),
                        var(--ch-1),
                        var(--ch-2),
                        var(--ch-3)
                    );

                background-size:
                    200% 200%,
                    200% 200%,
                    400% 400%;

                animation:
                    channelShift 12s ease-in-out infinite,
                    channelPulse 6s ease-in-out infinite alternate;

                filter: saturate(1.2);
            }

            .cell-inner:hover {
                background-color: #000000;
                opacity: 1;
                transition: .25s ease-in-out;
            }

            @keyframes channelShift {
                0% {
                    background-position:
                        0% 0%,
                        100% 100%,
                        0% 50%;
                    filter: hue-rotate(0deg);
                }

                25% {
                    background-position:
                        50% 20%,
                        80% 40%,
                        50% 0%;
                }

                50% {
                    background-position:
                        100% 100%,
                        0% 0%,
                        100% 50%;
                    filter: hue-rotate(120deg);
                }

                75% {
                    background-position:
                        40% 80%,
                        20% 60%,
                        50% 100%;
                }

                100% {
                    background-position:
                        0% 0%,
                        100% 100%,
                        0% 50%;
                    filter: hue-rotate(360deg);
                }
            }

            @keyframes channelPulse {
                0% {
                    filter: brightness(0.9) contrast(1.05) saturate(1.1);
                }
                100% {
                    filter: brightness(1.15) contrast(1.25) saturate(1.4);
                }
            }



            /* ===== INNER DARK CORE ===== */
            .cell-inner {
                background: #222;
                flex: 1;
                display: grid;
                grid-template-rows: auto 1fr auto;
                padding: 6%;
                box-sizing: border-box;
            }

            /* ===== GLYPH BANDS ===== */
            .glyph-top,
            .glyph-bottom {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 4%;
            }

            .glyph-slot {
                background: rgba(255,255,255,0.08);
                color: #eee;
                text-align: center;
                font-size: clamp(8px, 1.2vmin, 14px);
            }

            /* ===== CENTER ===== */
            .center {
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                text-align: center;
            }

            .uuid {
                color: #aaa;
                font-size: clamp(10px, 1.4vmin, 16px);
                text-shadow: 0 0 6px rgba(235, 235, 235, 0.6);
            }

            .owner {
                color: #aaa;
                font-size: clamp(8px, 1vmin, 12px);
                margin-top: 2px;
            }
        </style>

        <div id="error_toast"><div id="icon"><i class="ri-signal-wifi-error-line"></i></div><div id="error_desc"></div></div>
    </body>
</html>