<!DOCTYPE html>
<html lang="en">
    <head>
        
        <title>Map</title>
        <!-- https://remixicon.com/ -->
        <link
            href="https://cdn.jsdelivr.net/npm/remixicon@4.7.0/fonts/remixicon.css"
            rel="stylesheet"
        />
        <link rel="icon" type="image/png" sizes="512x512" href="favicon/android-chrome-512x512.png">
        <link rel="icon" type="image/png" sizes="192x192" href="favicon/android-chrome-192x192.png">
        <link rel="icon" type="image/png" sizes="32x32" href="favicon/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="favicon/favicon-16x16.png">
        <link rel="apple-touch-icon" href="favicon/apple-touch-icon.png">
        <link rel="alternate icon" href="favicon/favicon.ico">

        <script src="js/jquery-3.7.1.js"></script>

        <link rel="stylesheet" href="css/map.css">
        <link rel="stylesheet" href="css/common.css">

        <!-- Bots No Index No Follow -->
        <meta name="ROBOTS" content="NOINDEX,NOFOLLOW">

        <!-- For mobile support -->
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <meta name="theme-color" content="#3da79a">
        <meta property="og:site_name" content="Octo Application">
        <meta property="og:image" content="./img/about-bg.gif">
        <meta data-react-helmet="true" property="og:description" content="Lightweight repository project interacts with API Servers for a simple Data Library">    

    </head>
    <body>
        <div class="topnavigator">
            <div class="topleftbox">
                <div class="floating-right" id="loading">
                    <div class="bouncing-loader">
                        <div></div>
                        <div></div>
                        <div></div>
                    </div>
                </div>
                <div class="topnavleft">
                    <a href="index.html">
                        <i class="ri-base-station-fill"></i> status
                    </a>
                </div>
                <div class="topnavleft">
                    <a href="login.html?redirect=map.html" class="phasedBlue" id="user-login-nav">
                        <i class="ri-passport-line"></i> login
                    </a>
                </div>
                <div class="topnavleft">
                    <a href="#" class="phasedYel">
                        <i class="ri-treasure-map-line"></i> area
                    </a>
                </div>
                <div class="topnavleft">
                    <a href="#" class="phasedYel" id="x_minus">
                        <i class="ri-arrow-left-circle-line"></i> X-
                    </a>
                </div>
                <div class="topnavleft">
                    <a href="#" class="phasedYel" id="x_plus">
                        <i class="ri-arrow-right-circle-line"></i> X+
                    </a>
                </div>
                <div class="topnavleft">
                    <a href="#" class="phasedYel" id="y_minus">
                        <i class="ri-arrow-down-circle-line"></i> Y-
                    </a>
                </div>
                <div class="topnavleft">
                    <a href="#" class="phasedYel" id="y_plus">
                        <i class="ri-arrow-up-circle-line"></i> Y+
                    </a>
                </div>
                <div class="topnavleft">
                    <a href="#" class="phased">
                        <i class="ri-compass-discover-line"></i> search
                    </a>
                </div>

                <div class="skeleton-image" id="skeletonloading"></div>
            </div>
        </div>
        <div class="container">
            <!-- TODO : Content, Loading -->
        </div>


        <script type="text/javascript">

            function RenderFactory(url, x, y, z, apikey=null) {
                return $.ajax({
                    type: "POST",
                    url: url,
                    timeout: 3000,
                    contentType: "application/json",
                    dataType: "json",
                    headers: apikey ? { "X-API-Key": apikey } : {},
                    data: JSON.stringify({ 'x_axis': x, 'y_axis': y, 'z_axis': z, 'time_axis': null })
                })
            }

            function positiveNumber(params, param, fallback) {
                const v = Number(params.get(param));
                return Number.isFinite(v) && v > 0 ? v : fallback;
            }

            function nonNegativeNumber(params, param, fallback) {
                const v = Number(params.get(param));
                return Number.isFinite(v) && v >= 0 ? v : fallback;
            }

            function normalizeURL(x, y, z) {
                const params = new URLSearchParams();

                params.set("x", x);
                params.set("y", y);
                params.set("z", z);

                const newURL = `${window.location.pathname}?${params.toString()}`;

                window.history.replaceState({}, "", newURL);
            }

            function buildURL(x, y, z) {
                const params = new URLSearchParams({
                    x: x,
                    y: y,
                    z: z
                });

                return `${window.location.pathname}?${params.toString()}`;
            }

            function updateNavLinks(x, y, z) {
                $("#x_plus").attr("href", buildURL(x + 1, y, z));
                $("#x_minus").attr("href", buildURL(Math.max(0, x - 1), y, z));

                $("#y_plus").attr("href", buildURL(x, y + 1, z));
                $("#y_minus").attr("href", buildURL(x, Math.max(0, y - 1), z));
            }

            function getApiKeyFromCookie() {
                const match = document.cookie.match(/(?:^|; )X-API-Key=([^;]*)/);
                return match ? decodeURIComponent(match[1]) : null;
            }

            function toggleLoadingBar(force, loadingID='loading') {
                const loading = document.getElementById(loadingID);

                if (force !== undefined) {
                    // If force is provided, explicitly set display
                    loading.style.display = force ? 'block' : 'none';
                } else {
                    // Otherwise, toggle
                    loading.style.display = (loading.style.display === 'none') ? 'block' : 'none';
                }
            }

            function launch_error_toast(error_text) {
                var t = document.getElementById("error_toast")
                var d = document.getElementById("error_desc")
                t.className = "show";
                d.innerText = error_text;
                setTimeout(function(){ t.className = t.className.replace("show", ""); }, 5000);
            }

            function illuminate(res) {
                b = res.banner;
                document.documentElement.style.setProperty('--banner-channel-0', b[0]);
                document.documentElement.style.setProperty('--banner-channel-1', b[1]);
                document.documentElement.style.setProperty('--banner-channel-2', b[2]);
                document.documentElement.style.setProperty('--banner-channel-3', b[3]);
                document.documentElement.style.setProperty('--banner-channel-4', b[4]);
                document.documentElement.style.setProperty('--banner-channel-5', b[5]);
                document.documentElement.style.setProperty('--banner-channel-6', b[6]);
                document.documentElement.style.setProperty('--banner-channel-7', b[7]);
            }

            function ChangeUserNav(res) {
                nav = document.getElementById('user-login-nav');
                if (res.user_context.decryption_success) {
                    nav.href = '#'; // This will point to the user page
                    nav.innerHTML = '<i class="ri-passport-fill"></i> ' + String(res.user_context.ID).split('-')[0];
                } else {
                    nav.href = `login.html?redirect=${encodeURIComponent(window.location.pathname + window.location.search)}`;
                }
            }

            document.addEventListener("DOMContentLoaded", function () {

                // Get params from location
                const params = new URLSearchParams(window.location.search);

                const xpos = Math.floor(nonNegativeNumber(params, 'x', 0));
                const ypos = Math.floor(nonNegativeNumber(params, 'y', 0));
                // Enforce [0,1,2,3,4]
                const zone = Math.min(4, Math.max(0, Math.floor(nonNegativeNumber(params, 'z', 0))));

                const apiKey = getApiKeyFromCookie();

                console.log(xpos, ypos, zone, apiKey)

                // normalize & update navigation
                normalizeURL(xpos, ypos, zone);
                updateNavLinks(xpos, ypos, zone);

                // Load Data from Server
                RenderFactory("https://octo.shadowsword.ca/api/render", xpos, ypos, zone, apiKey)
                .done(function (res) {
                    if (res.message == "OK") {
                        illuminate(res)
                        ChangeUserNav(res)
                        toggleLoadingBar(false) // for now, before we get into real data loading
                        toggleLoadingBar(false, 'skeletonloading')
                    }
                    console.log(res)
                })
                .fail(function () {
                    // fallback
                    console.warn("Couldn't establish DNS connection, falling back to localhost.")
                    RenderFactory("http://localhost:9300/api/render", xpos, ypos, zone)
                    .done(function (res) {
                        if (res.message == "OK") {
                            illuminate(res)
                            ChangeUserNav(res)
                            toggleLoadingBar(false) // for now, before we get into real data loading
                            toggleLoadingBar(false, 'skeletonloading')
                        }
                        console.log(res)
                    })
                    .fail(function () {
                        // Cannot load page, display Error Message
                        console.warn('Cannot establish server connection.')
                        launch_error_toast('Cannot establish server connection.')
                        toggleLoadingBar(false)
                        toggleLoadingBar(false, 'skeletonloading')
                    });
                });

            });


        </script>
        <div id="error_toast"><div id="icon"><i class="ri-signal-wifi-error-line"></i></div><div id="error_desc"></div></div>
    </body>
</html>