<!DOCTYPE html>

<html lang="en">
    <head>
        
        <title>User</title>
        <!-- https://remixicon.com/ -->
        <link
            href="https://cdn.jsdelivr.net/npm/remixicon@4.7.0/fonts/remixicon.css"
            rel="stylesheet"
        />
        <link rel="icon" type="image/png" sizes="512x512" href="favicon/android-chrome-512x512.png">
        <link rel="icon" type="image/png" sizes="192x192" href="favicon/android-chrome-192x192.png">
        <link rel="icon" type="image/png" sizes="32x32" href="favicon/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="favicon/favicon-16x16.png">
        <link rel="apple-touch-icon" href="favicon/apple-touch-icon.png">
        <link rel="alternate icon" href="favicon/favicon.ico">

        <script src="js/jquery-3.7.1.js"></script>

        <link rel="stylesheet" href="./css/common.css">
        <link rel="stylesheet" href="./css/login.css">

        <!-- Bots No Index No Follow -->
        <meta name="ROBOTS" content="NOINDEX,NOFOLLOW">

        <!-- For mobile support -->
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <meta name="theme-color" content="#3da79a">
        <meta property="og:site_name" content="Octo Application">
        <meta property="og:image" content="./img/about-bg.gif">
        <meta data-react-helmet="true" property="og:description" content="Lightweight repository project interacts with API Servers for a simple Data Library">    

    </head>
    <body>
        <div class="content">
            <div class="bouncing-loader" id="loading">
                <div></div>
                <div></div>
                <div></div>
            </div>
            <div id="noshow" style="display: none;">
                <form action="javascript:void(0)" novalidate>
                    <h2 id="user_id"></h2>

                    <div style="width: 100%; text-align: center; font-size: clamp(16px, 1.4vmin, 20px);" id="uuid"></div>
                    <br>
                    Account Age: <x id="days_old_value">--</x> / 365
                    <div class="progressbar"><div id="days_old"></div></div>
                    <br>
                    <!-- Currently executes nothing -->
                    <button type="submit" class="btnn">Renew API Key</button>

                    <div class="button">
                    <a href="https://github.com/shir0tetsuo/octo"> <i class="ri-github-line"></i> Project Page </a>
                    --
                    <a href="./index.html"> <i class="ri-cloud-fill"></i> Status</a>
                    </div>
                </form>
            </div>
        </div>

    </body>
    <script type="text/javascript">
        function safeRedirect(path) {
            if (path && path.startsWith("/") && !path.startsWith("//")) {
                window.location.href = path;
            } else {
                window.location.href = "./index.html";
            }
        }

        function reveal_content() {
            l = document.getElementById("loading")
            l.style.setProperty("display", 'none')
            c = document.getElementById("noshow")
            c.style.setProperty("display", "block")
        }

        function launch_error_toast(error_text) {
            var t = document.getElementById("error_toast")
            var d = document.getElementById("error_desc")
            t.className = "show";
            d.innerText = error_text;
            setTimeout(function(){ t.className = t.className.replace("show", ""); }, 5000);
        }

        // Do not remove.
        function setCookie(name, value, days) {
            let expires = "";
            if (days) {
                const date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                expires = "; expires=" + date.toUTCString();
            }
            const isHttps = location.protocol === "https:";
            document.cookie =
                name + "=" + encodeURIComponent(value) +
                expires +
                "; path=/; SameSite=Strict" +
                (isHttps ? "; Secure" : "");
        }

        function checkKey(url, apiKey) {
            return $.ajax({
                type: "POST",
                url: url,
                timeout: 2000,
                contentType: "application/json",
                dataType: "json",
                data: JSON.stringify({ APIKey: apiKey })
            });
        }

        function getApiKeyFromCookie() {
            const match = document.cookie.match(/(?:^|; )X-API-Key=([^;]*)/);
            return match ? decodeURIComponent(match[1]) : null;
        }

        function safeExit() {
            const params = new URLSearchParams(window.location.search);
            const redirectTo = params.get("redirect") || "./index.html";
            safeRedirect();
        }

        // main
        function handleSuccess(response) {
            console.log('Server responds with data.')
            console.log(response)
            if ( !response?.decryption_success) { safeExit(); };

            // Render UUID
            const uuid_element = document.getElementById("uuid");
            const id_element = document.getElementById("user_id");
            const id_short = response?.ID.split('-')[0];
            id_element.innerText = id_short;
            uuid_element.innerHTML = response?.ID || 'Unknown/Error';
            // Render progress bar for account age
            const days_element = document.getElementById("days_old");
            const days_old_actual = response?.days_old || 0;
            const days_v = document.getElementById("days_old_value");
            days_v.innerText = days_old_actual;
            const percent_old = Math.floor(days_old_actual * 0.273972602739726); // (365 Days)
            days_element.style.setProperty('--progresspercent', `${percent_old}%`);
            days_element.style.setProperty('--xch0', '#ff0000');
            days_element.style.setProperty('--xch1', '#2d2d2d');
            days_element.className = 'prog';

            reveal_content()
        }

        document.addEventListener("DOMContentLoaded", function () {

            const apiKey = getApiKeyFromCookie()
            if (!apiKey) {
                return safeExit();
            }


            checkKey("https://octo.shadowsword.ca/api/APIKey", apiKey)
                .done(handleSuccess)
                .fail(function () {
                    console.warn("Couldn't establish DNS connection, falling back to localhost.")
                    checkKey("http://localhost:9300/api/APIKey", apiKey)
                        .done(handleSuccess)
                        .fail(function () {
                            // force exit if invalid key
                            safeExit();
                        });
                });

        });
    </script>
    <div id="error_toast"><div id="icon"><i class="ri-signal-wifi-error-line"></i></div><div id="error_desc"></div></div>


</html>
